<!doctype html>

<head>
  <meta charset="UTF-8">
  <title>vaadin-overlay tests</title>
  <script src="../../web-component-tester/browser.js"></script>
  <link rel="import" href="../../iron-test-helpers/iron-test-helpers.html">
  <link rel="import" href="../vaadin-overlay.html">
</head>

<body>
  <test-fixture id="default">
    <template>
      <div>
        <div id="parent">
          <vaadin-overlay>
            <template>content</template>
          </vaadin-overlay>
        </div>
      </div>
    </template>
  </test-fixture>

  <script>
    describe('overlay', function() {
      var overlay, parent, content, backdrop;

      beforeEach(function() {
        parent = fixture('default').children[0];
        overlay = parent.children[0];
        content = overlay.$.content;
        backdrop = overlay.$.backdrop;
        overlay._observer.flush();
        overlay.opened = true;
      });

      it('should move under body when open', () => {
        expect(overlay.parentElement).to.eql(document.body);
      });

      it('should prevent clicking elements outside overlay', () => {
        expect(document.body.style.pointerEvents).to.eql('none');
      });

      it('should move back to original place after closing', () => {
        overlay.opened = false;

        expect(overlay.parentElement).to.eql(parent);
      });

      it('should stamp contents inside shadow root', () => {
        expect(overlay.root.textContent).to.contain('content');
      });

      it('should close on esc', () => {
        MockInteractions.pressAndReleaseKeyOn(document.body, 27);

        expect(overlay.opened).to.be.false;
      });

      it('backdrop should be toggled by with-backdrop attribute', () => {
        expect(backdrop.hidden).to.be.true;

        overlay.setAttribute('with-backdrop', true);

        expect(backdrop.hidden).to.be.false;
      });

      it('should fire the vaadin-overlay-escape-press event only when ESC pressed', function(done) {
        var doneHandler = () => done();

        overlay.addEventListener('vaadin-overlay-escape-press', doneHandler, false);

        MockInteractions.pressAndReleaseKeyOn(document.body, 27);
        MockInteractions.pressAndReleaseKeyOn(document.body, 13);

        overlay.removeEventListener('vaadin-overlay-escape-press', doneHandler, false);
      });

      it('should not close on esc if vaadin-overlay-escape-press event was canceled', () => {
        overlay.addEventListener('vaadin-overlay-escape-press', e => {
          e.preventDefault();
        });

        MockInteractions.pressAndReleaseKeyOn(document.body, 27);

        expect(overlay.opened).to.be.true;
      });

      it('should fire the vaadin-overlay-tab-press event only when TAB pressed', function(done) {
        var doneHandler = () => done();

        overlay.addEventListener('vaadin-overlay-tab-press', doneHandler, false);

        MockInteractions.pressAndReleaseKeyOn(document.body, 9);
        MockInteractions.pressAndReleaseKeyOn(document.body, 13);

        overlay.removeEventListener('vaadin-overlay-tab-press', doneHandler, false);
      });

      it('should not close on inside click', () => {
        content.click();

        expect(overlay.opened).to.be.true;
      });

      it('should fire the vaadin-overlay-outside-click event on outside click', function(done) {
        var outsideClickHandler = () => done();

        overlay.addEventListener('vaadin-overlay-outside-click', outsideClickHandler, false);
        parent.click();
        overlay.removeEventListener('vaadin-overlay-outside-click', outsideClickHandler, false);
      });

      it('should fire the vaadin-overlay-outside-click event on backdrop click', function(done) {
        var outsideClickHandler = () => done();

        overlay.withBackdrop = true;
        overlay.addEventListener('vaadin-overlay-outside-click', outsideClickHandler, false);
        backdrop.dispatchEvent(new CustomEvent('click', {bubbles: true, composed: true}));
        overlay.removeEventListener('vaadin-overlay-outside-click', outsideClickHandler, false);
      });

      it('should not fire the vaadin-overlay-outside-click event on inside click', () => {
        var outsideClickHandler = () => {
          throw new Error('Should not come here!');
        };

        overlay.addEventListener('vaadin-overlay-outside-click', outsideClickHandler, false);
        content.click();
        overlay.removeEventListener('vaadin-overlay-outside-click', outsideClickHandler, false);
      });

      it('should close on outside click', () => {
        parent.click();

        expect(overlay.opened).to.be.false;
      });

      it('should not close on outside click if vaadin-overlay-outside-click event was canceled', () => {
        overlay.addEventListener('vaadin-overlay-outside-click', e => {
          e.preventDefault();
        });
        parent.click();

        expect(overlay.opened).to.be.true;
      });

      it('should not close on backdrop click if vaadin-overlay-outside-click event was canceled', () => {
        overlay.addEventListener('vaadin-overlay-outside-click', e => {
          e.preventDefault();
        });
        backdrop.click();

        expect(overlay.opened).to.be.true;
      });

      it('should close on the backdrop click', () => {
        overlay.withBackdrop = true;

        backdrop.dispatchEvent(new CustomEvent('click', {bubbles: true, composed: true}));

        expect(overlay.opened).to.be.false;
      });

      it('should prevent closing the overlay when preventing vaadin-overlay-cancel', done => {
        overlay.addEventListener('vaadin-overlay-close', e => {
          e.preventDefault();

          setTimeout(() => {
            expect(overlay.opened).to.be.true;
            done();
          }, 1);
        });

        parent.click();
      });
    });
  </script>
</body>
